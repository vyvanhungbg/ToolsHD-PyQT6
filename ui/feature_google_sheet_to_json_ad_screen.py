from PyQt6.QtWidgets import QVBoxLayout, QPushButton, QSizePolicy
import json
import string
import sys
import pandas as pd
import gspread
from PyQt6.QtCore import QTimer, Qt
from PyQt6.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QPushButton,
    QLineEdit, QTableView, QHBoxLayout, QLabel, QMessageBox, QComboBox
)
from PyQt6.QtGui import QStandardItemModel, QStandardItem
from google.oauth2 import id_token
from oauth2client.service_account import ServiceAccountCredentials
from googleapiclient.discovery import build
from google.oauth2.credentials import Credentials
import pandas as pd
from utils.encrypt_utils import load_and_decrypt_token, encrypt_and_save_token
from PyQt6.QtGui import QStandardItemModel, QStandardItem
from google.oauth2.credentials import Credentials
from google.auth.transport.requests import Request
from base.base_widget import BaseWidget


def column_letters(n):
    """Chuy·ªÉn s·ªë th·ª© t·ª± th√†nh A, B, C, ..., Z, AA, AB,... gi·ªëng Google Sheets"""
    result = []
    while n > 0:
        n, remainder = divmod(n - 1, 26)
        result.append(string.ascii_uppercase[remainder])
    return ''.join(result[::-1])


def find_columns_with_abc(table_view):
    model = table_view.model()
    if not model:
        return None, None, None  # N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu

    # T√¨m h√†ng ƒë·∫ßu ti√™n trong c·ªôt A c√≥ "Version"
    version_row = None
    for row in range(model.rowCount()):
        index = model.index(row, 0)  # C·ªôt A (index 0)
        text_col_version = (index.data() or "").lower()
        if "version" in text_col_version:
            version_row = row
            break

    if version_row is None:
        return None, None, None  # Kh√¥ng t√¨m th·∫•y "Version"

    # T√¨m c√°c c·ªôt ch·ª©a "A", "B", "C" trong d√≤ng ƒë√≥
    index_ad_format = 0
    index_space_name = 0
    index_ad_id = 0
    for col in range(model.columnCount()):
        index = model.index(version_row, col)
        text_col = (index.data() or "").lower()
        if "format" in text_col or "type" in text_col:
            index_ad_format = col
        if "id" in text_col:
            index_ad_id = col
        if "space" in text_col or "name" in text_col:
            index_space_name = col
    print(f"{version_row}, {index_ad_id}, {index_space_name}, {index_ad_format}")
    return index_ad_format, index_space_name, index_ad_id


class FeatureGoogleSheetToJsonAdScreen(BaseWidget):
    def __init__(self, navigation):
        super().__init__(navigation)
        self.sheet_names = []  # üîπ L∆∞u danh s√°ch sheet ƒë·ªÉ kh√¥ng ph·∫£i g·ªçi API l·∫°i

        # üîπ Thi·∫øt l·∫≠p giao di·ªán
        self.setWindowTitle("Google Sheet Viewer")
        self.resize(800, 800)

        # üîπ Layout ch√≠nh
        layout = QVBoxLayout()

        # üîπ Label h∆∞·ªõng d·∫´n
        self.label = QLabel("Nh·∫≠p ƒë∆∞·ªùng d·∫´n Google Sheet:")
        layout.addWidget(self.label)

        # üîπ √î nh·∫≠p ƒë∆∞·ªùng d·∫´n Sheet
        self.sheet_url_input = QLineEdit(self)
        self.sheet_url_input.setText(
            "https://docs.google.com/spreadsheets/d/1ExLQRdg1mKGPbfDD4Zpioz2eW4FW1LGWG-40dMrY2TM")
        layout.addWidget(self.sheet_url_input)

        self.label = QLabel("üìú Ch·ªçn Sheet:")
        layout.addWidget(self.label)

        # üîπ Dropdown ch·ªçn sheet
        self.sheet_dropdown = QComboBox()
        layout.addWidget(self.sheet_dropdown)
        self.sheet_dropdown.currentIndexChanged.connect(
            lambda index: self.load_google_sheet(self.sheet_dropdown.currentText()))
        # self.sheet_dropdown.currentIndexChanged.connect(lambda index: QTimer.singleShot(0, lambda: self.load_google_sheet(self.sheet_dropdown.currentText())))
        # üîπ Khu v·ª±c ch·ª©a 2 n√∫t
        button_layout = QHBoxLayout()

        self.load_button = QPushButton("Load")
        self.load_button.clicked.connect(lambda: self.load_google_sheet(None))
        button_layout.addWidget(self.load_button)

        self.close_button = QPushButton("ƒê√≥ng")
        self.close_button.clicked.connect(self.close)
        button_layout.addWidget(self.close_button)

        layout.addLayout(button_layout)

        # V√πng edit text ch·ªçn √¥

        input_layout = QVBoxLayout()

        # H√†ng b·∫Øt ƒë·∫ßu
        row_range_layout = QHBoxLayout()

        self.label_start = QLabel("T·ª´ d√≤ng", self)
        self.label_start.setFixedWidth(60)
        row_range_layout.addWidget(self.label_start)

        self.start_row_range_selected = QLineEdit(self)
        self.start_row_range_selected.setFixedWidth(100)
        self.start_row_range_selected.setSizePolicy(QSizePolicy.Policy.Fixed,
                                                    QSizePolicy.Policy.Fixed)  # Kh√¥ng cho gi√£n

        row_range_layout.addWidget(self.start_row_range_selected)
        row_range_layout.setAlignment(Qt.AlignmentFlag.AlignLeft)

        self.label_end = QLabel("ƒê·∫øn d√≤ng", self)
        self.label_end.setFixedWidth(60)
        row_range_layout.addWidget(self.label_end)

        self.end_row_range_selected = QLineEdit(self)
        self.end_row_range_selected.setFixedWidth(100)
        self.end_row_range_selected.setSizePolicy(QSizePolicy.Policy.Fixed,
                                                  QSizePolicy.Policy.Fixed)  # Kh√¥ng cho gi√£n

        row_range_layout.addWidget(self.end_row_range_selected)
        row_range_layout.setAlignment(Qt.AlignmentFlag.AlignLeft)

        input_layout.addLayout(row_range_layout)
        # H√†ng th√¥ng tin c·ªôt ads
        col_ad_attr_layout = QHBoxLayout()

        # adtype
        self.label_ad_type = QLabel("C·ªôt AdType", self)
        self.label_ad_type.setFixedWidth(70)
        col_ad_attr_layout.addWidget(self.label_ad_type)

        self.col_ad_type = QLineEdit(self)
        self.col_ad_type.setFixedWidth(100)
        self.col_ad_type.setSizePolicy(QSizePolicy.Policy.Fixed,
                                       QSizePolicy.Policy.Fixed)  # Kh√¥ng cho gi√£n

        col_ad_attr_layout.addWidget(self.col_ad_type)
        col_ad_attr_layout.setAlignment(Qt.AlignmentFlag.AlignLeft)

        #space name
        self.label_space_name = QLabel("C·ªôt Space", self)
        self.label_space_name.setFixedWidth(70)
        col_ad_attr_layout.addWidget(self.label_space_name)

        self.col_space_name = QLineEdit(self)
        self.col_space_name.setFixedWidth(100)
        self.col_space_name.setSizePolicy(QSizePolicy.Policy.Fixed,
                                          QSizePolicy.Policy.Fixed)  # Kh√¥ng cho gi√£n

        col_ad_attr_layout.addWidget(self.col_space_name)
        col_ad_attr_layout.setAlignment(Qt.AlignmentFlag.AlignLeft)

        #ad id

        self.label_id_ad = QLabel("C·ªôt ID Ad", self)
        self.label_id_ad.setFixedWidth(60)
        col_ad_attr_layout.addWidget(self.label_id_ad)

        self.col_id_ad = QLineEdit(self)
        self.col_id_ad.setFixedWidth(100)
        self.col_id_ad.setSizePolicy(QSizePolicy.Policy.Fixed,
                                     QSizePolicy.Policy.Fixed)  # Kh√¥ng cho gi√£n

        col_ad_attr_layout.addWidget(self.col_id_ad)
        col_ad_attr_layout.setAlignment(Qt.AlignmentFlag.AlignLeft)

        input_layout.addLayout(col_ad_attr_layout)

        layout.addLayout(input_layout)

        # üîπ B·∫£ng hi·ªÉn th·ªã d·ªØ li·ªáu
        self.table_view = QTableView(self)

        layout.addWidget(self.table_view)

        self.setLayout(layout)

    def on_selection_changed(self):
        selected_indexes = self.table_view.selectionModel().selectedIndexes()

        if not selected_indexes:
            return

        # L·∫•y c·ªôt nh·ªè nh·∫•t v√† l·ªõn nh·∫•t
        min_col = min(index.column() for index in selected_indexes)
        max_col = max(index.column() for index in selected_indexes)
        min_row = min(index.row() for index in selected_indexes)
        max_row = max(index.row() for index in selected_indexes)

        print(f"Start Column: {column_letters(min_col + 1)}, End Column: {column_letters(max_col + 1)}")
        print(f"Start Row: {min_row}, End Row: {max_row}")
        self.start_row_range_selected.setText(str(min_row + 1))
        self.end_row_range_selected.setText(str(max_row + 1))

    def load_google_sheet(self, sheet_selected: str = None):
        """T·∫£i d·ªØ li·ªáu t·ª´ Google Sheet v√† hi·ªÉn th·ªã v√†o b·∫£ng."""
        sheet_url = self.sheet_url_input.text().strip()

        if not sheet_url:
            QMessageBox.warning(self, "L·ªói", "Vui l√≤ng nh·∫≠p ƒë∆∞·ªùng d·∫´n Google Sheet!")
            return

        # üõë N·∫øu link Google Sheet thay ƒë·ªïi, reset danh s√°ch sheet v√† load l·∫°i
        if not hasattr(self, "current_sheet_url") or self.current_sheet_url != sheet_url:
            self.current_sheet_url = sheet_url
            self.sheet_names = []  # Xo√° danh s√°ch sheets c≈©

        try:
            # ‚úÖ N·∫øu ch∆∞a c√≥ danh s√°ch sheet, g·ªçi API v√† c·∫≠p nh·∫≠t dropdown
            if not self.sheet_names:
                self.sheet_names = self.get_sheet_names(sheet_url)
                if not self.sheet_names:
                    QMessageBox.warning(self, "L·ªói", "Kh√¥ng th·ªÉ l·∫•y danh s√°ch sheets!")
                    return

                # üõë Ch·∫∑n t√≠n hi·ªáu khi c·∫≠p nh·∫≠t dropdown ƒë·ªÉ tr√°nh g·ªçi l·∫°i load_google_sheet
                self.sheet_dropdown.blockSignals(True)
                self.sheet_dropdown.clear()
                self.sheet_dropdown.addItems(self.sheet_names)
                self.sheet_dropdown.blockSignals(False)

            # üìù N·∫øu kh√¥ng ch·ªçn sheet, m·∫∑c ƒë·ªãnh l·∫•y sheet ƒë·∫ßu ti√™n
            if not sheet_selected or sheet_selected not in self.sheet_names:
                sheet_selected = self.sheet_dropdown.currentText()

            # üöÄ Lu√¥n g·ªçi API ƒë·ªÉ l·∫•y d·ªØ li·ªáu m·ªõi
            df = self.get_google_sheet_data(sheet_url, sheet_selected)

            if df is not None:
                self.update_table(df)
                self.table_view.selectionModel().selectionChanged.connect(self.on_selection_changed)

            else:
                QMessageBox.warning(self, "L·ªói", "Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ Google Sheet!")

        except Exception as e:
            print(e)
            QMessageBox.critical(self, "L·ªói", f"L·ªói t·∫£i d·ªØ li·ªáu: {str(e)}")

    def get_sheet_names(self, sheet_url):
        """üîπ L·∫•y danh s√°ch c√°c sheets t·ª´ Google Sheets API."""
        try:
            creds = get_google_credentials()
            if not creds:
                return []

            sheet_id = self.extract_sheet_id(sheet_url)
            service = build("sheets", "v4", credentials=creds)

            # üü¢ Ch·ªâ l·∫•y metadata, kh√¥ng t·∫£i d·ªØ li·ªáu
            sheet_metadata = service.spreadsheets().get(spreadsheetId=sheet_id).execute()
            sheets = sheet_metadata.get("sheets", [])
            sheet_names = [sheet["properties"]["title"] for sheet in sheets]

            return sheet_names

        except Exception as e:
            print("‚ùå L·ªói khi l·∫•y danh s√°ch sheets:", str(e))
            return []

    def get_google_sheet_data(self, sheet_url, sheet_selected):
        """üîπ T·∫£i d·ªØ li·ªáu t·ª´ Google Sheets."""
        try:
            creds = get_google_credentials()
            if not creds:
                return None

            sheet_id = self.extract_sheet_id(sheet_url)
            service = build("sheets", "v4", credentials=creds)
            sheet = service.spreadsheets()

            # üìå Ch·ªâ ƒë·ªçc d·ªØ li·ªáu t·ª´ sheet ƒë√£ ch·ªçn
            range_name = f"{sheet_selected}!A1:Z1000"
            result = sheet.values().get(spreadsheetId=sheet_id, range=range_name).execute()
            data = result.get("values", [])

            if not data:
                QMessageBox.warning(None, "L·ªói", "Kh√¥ng c√≥ d·ªØ li·ªáu trong Google Sheet!")
                return None

            print(f"‚úÖ ƒê·ªçc th√†nh c√¥ng {len(data)} d√≤ng t·ª´ Google Sheet!")

            return self.convert_to_dataframe(data)

        except Exception as e:
            print("‚ùå L·ªói khi truy c·∫≠p Google Sheet:", str(e))
            QMessageBox.critical(None, "L·ªói", f"L·ªói t·∫£i Google Sheet: {str(e)}")
            return None

    def convert_to_dataframe(self, data):
        """üîπ Chuy·ªÉn d·ªØ li·ªáu Google Sheet th√†nh Pandas DataFrame v·ªõi ti√™u ƒë·ªÅ A, B, C, ..."""
        if not data:
            return pd.DataFrame()

        max_columns = max(len(row) for row in data)

        # üöÄ T·∫°o ti√™u ƒë·ªÅ A, B, C, ..., Z, AA, AB,...
        header = [column_letters(i + 1) for i in range(max_columns)]

        # üîπ Chu·∫©n h√≥a d·ªØ li·ªáu (ƒë·∫£m b·∫£o ƒë·ªß s·ªë c·ªôt)
        normalized_data = [row + [None] * (max_columns - len(row)) for row in data]

        # üîπ T·∫°o DataFrame
        return pd.DataFrame(normalized_data, columns=header)

    def extract_sheet_id(self, sheet_url):
        """üîπ Tr√≠ch xu·∫•t Google Sheet ID t·ª´ URL."""
        try:
            return sheet_url.split("/d/")[1].split("/")[0]
        except IndexError:
            raise ValueError("URL Google Sheet kh√¥ng h·ª£p l·ªá! H√£y ki·ªÉm tra l·∫°i.")

    def update_table(self, df):
        """ H√†m c·∫≠p nh·∫≠t d·ªØ li·ªáu v√†o b·∫£ng """
        model = QStandardItemModel(df.shape[0], df.shape[1])

        # üîπ ƒê·∫∑t ti√™u ƒë·ªÅ c·ªôt
        model.setHorizontalHeaderLabels(df.columns)

        for row in range(df.shape[0]):
            for col in range(df.shape[1]):
                item = QStandardItem(str(df.iat[row, col]))
                model.setItem(row, col, item)

        self.table_view.setModel(model)
        index_ad_format, index_space_name, index_ad_id = find_columns_with_abc(self.table_view)
        if index_ad_format is not None and index_ad_format != 0  :
            self.col_ad_type.setText(column_letters(index_ad_format + 1))
        else:
            self.col_ad_type.setText("")
        if index_ad_id is not None and index_ad_id != 0:
            self.col_id_ad.setText(column_letters(index_ad_id + 1))
        else:
            self.col_id_ad.setText("")
        if index_space_name is not None and index_space_name != 0:
            self.col_space_name.setText(column_letters(index_space_name + 1))
        else:
            self.col_space_name.setText("")

SCOPES = [
    "https://www.googleapis.com/auth/spreadsheets.readonly"
]


def get_google_credentials():
    """üîπ T·∫£i token, ki·ªÉm tra v√† l√†m m·ªõi n·∫øu h·∫øt h·∫°n"""
    try:
        token_data = load_and_decrypt_token()  # üîπ Token ƒë√£ ƒë∆∞·ª£c gi·∫£i m√£ t·ª´ file

        if isinstance(token_data, str):
            token_data = json.loads(token_data)  # üîπ Chuy·ªÉn t·ª´ chu·ªói JSON sang dictionary

        # üîπ Ki·ªÉm tra xem token c√≥ ƒë·∫ßy ƒë·ªß th√¥ng tin kh√¥ng
        required_keys = {"token", "refresh_token", "token_uri", "client_id", "client_secret"}
        if not required_keys.issubset(token_data):
            raise ValueError("Token kh√¥ng h·ª£p l·ªá ho·∫∑c thi·∫øu th√¥ng tin!")

        # üîπ T·∫°o credentials t·ª´ token
        creds = Credentials(
            token=token_data["token"],
            refresh_token=token_data["refresh_token"],
            token_uri=token_data["token_uri"],
            client_id=token_data["client_id"],
            client_secret=token_data["client_secret"],
            scopes=SCOPES
        )

        # üîπ Ki·ªÉm tra token h·∫øt h·∫°n ch∆∞a
        if creds.expired and creds.refresh_token:
            creds.refresh(Request())  # üîπ L√†m m·ªõi token
            encrypt_and_save_token(creds.to_json())  # üîπ L∆∞u l·∫°i token m·ªõi

        return creds

    except Exception as e:
        print("L·ªói khi l·∫•y token:", e)
        return None
